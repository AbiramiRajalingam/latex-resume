
\documentclass{article}
\input{test2e}

\showoutput

\begin{document}

\START

\makeatletter

\def\testt#1#2#3#4{%
  #4%
  \DeclareCommandCopy#1#3%
  \testtt#1
  \expandafter\testtt\csname#2\space\endcsname
  \expandafter\testtt\csname\string#1\endcsname
  \expandafter\testtt\csname\string#1\space\endcsname
  \typeout{}}
\def\testtt#1{%
  \typeout{\string#1=\meaning#1|}%
  \let#1\undefined}

%% etoolbox emulation
\def\@carsquare#1#2#3\@nil{#1#2}
\def\ifrobustcmd#1{%
  \edef\etb@tempa{\noexpand\@testopt
    \expandafter\noexpand\csname\string#1\endcsname}%
  \edef\etb@tempb{\unexpanded\expandafter\expandafter\expandafter
    {\expandafter\@carsquare#1{}{}\@nil}}%
  \ifx\etb@tempa\etb@tempb
    \expandafter\@firstoftwo
  \else
    \expandafter\@secondoftwo
  \fi}
\def\letrobustcmd#1#2{%
  \protected\edef#1{\noexpand\@testopt
    \expandafter\noexpand\csname\string#1\endcsname}%
  \expandafter\let
    \csname\string#1\expandafter\endcsname
    \csname\string#2\endcsname}
\g@addto@macro\@declarecommandcopylisthook
  {\ifrobustcmd\letrobustcmd}
%%

% Here we need control words
\def\test{\testt\tmp{tmp}}

\test\cmda{\newcommand\cmda[1][]{boo}}

\test\cmdb{\DeclareRobustCommand\cmdb[1]{boo}}

\test\cmdc{\DeclareRobustCommand\cmdc[1][]{boo}}

\test\cmdd{%
  \protected\edef\cmdd{\noexpand\@testopt
    \expandafter\noexpand\csname\string\cmdd\endcsname{}}%
  \expandafter\def\csname\string\cmdd\endcsname[#1]{boo}}

% And here control symbols
\def\test{\testt\+{+}}

\test\!{\renewcommand\![1][]{boo}}

\test\#{\DeclareRobustCommand\#[1]{boo}}

\test\${\DeclareRobustCommand\$[1][]{boo}}

\test\%{%
  \protected\edef\%{\noexpand\@testopt
    \expandafter\noexpand\csname\string\%\endcsname{}}%
  \expandafter\def\csname\string\%\endcsname[#1]{boo}}

\end{document}

